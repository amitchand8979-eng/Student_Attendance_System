{% extends 'base.html' %}

{% block content %}
<h2 class="mb-4">Mark Attendance</h2>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Date: <span id="current-date">{{ today }}</span></h5>
        <input type="date" id="attendance-date" class="form-control" style="width: 200px;" value="{{ today }}">
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Department</th>
                        <th>Student ID</th>
                        <th>Status</th>
                        <th>Note</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for teacher in teachers %}
                    <tr data-teacher-id="{{ teacher.id }}">
                        <td>{{ teacher.name }}</td>
                        <td>{{ teacher.department }}</td>
                        <td>{{ teacher.employee_id }}</td>
                        <td>
                            <select class="form-select status-select">
                                <option value="">Select Status</option>
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Leave">Leave</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" class="form-control note-input" placeholder="Optional note">
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm save-btn">Save</button>
                            <span class="text-success save-status" style="display: none;">âœ“ Saved</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        
        $('#attendance-date').change(function() {
            $('#current-date').text($(this).val());
           
            $('.save-status').hide();
        });

        
        $(document).on('click', '.save-btn', function() {
            const btn = $(this);
            const row = btn.closest('tr');
            const teacherId = row.data('teacher-id');
            const status = row.find('.status-select').val();
            const note = row.find('.note-input').val();
            const date = $('#attendance-date').val();
            
            if (!status) {
                alert('Please select an attendance status');
                return;
            }
            
            
            $.ajax({
                url: '/api/mark_attendance',
                method: 'POST',
                data: {
                    teacher_id: teacherId,
                    date: date,
                    status: status,
                    note: note
                },
                success: function(response) {
                    if (response.success) {
                        
                        btn.hide();
                        row.find('.save-status').show();
                        
                        
                        setTimeout(function() {
                            btn.show();
                            row.find('.save-status').hide();
                        }, 3000);
                    }
                },
                error: function(error) {
                    alert('Error saving attendance: ' + error.responseText);
                }
            });
        });
        
        
        function loadAttendanceData() {
            const date = $('#attendance-date').val();
            
            $.getJSON('/api/get_attendance?date=' + date, function(data) {
                
                $('tr[data-teacher-id]').each(function() {
                    $(this).find('.status-select').val('');
                    $(this).find('.note-input').val('');
                    $(this).find('.save-status').hide();
                });
                
    
                data.forEach(function(record) {
                    const row = $('tr[data-teacher-id="' + record.teacher_id + '"]');
                    if (row.length) {
                        row.find('.status-select').val(record.status);
                        row.find('.note-input').val(record.note || '');
                       
                        row.find('.save-btn').hide();
                        row.find('.save-status').show();
                    }
                });
            });
        }
        
       
        loadAttendanceData();
        $('#attendance-date').change(loadAttendanceData);
    });
</script>
{% endblock %}